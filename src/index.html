<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
<div class="layui-tab">
    <ul class="layui-tab-title">
        <li class="layui-this">首页</li>
        <li>用户管理</li>
        <li>积分管理</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <form class="layui-form" action="" lay-filter="user_form">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">卡号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="card" autocomplete="off" class="layui-input" >
                        </div>
                        <button id="search" class="layui-btn">查询</button>
                    </div>
                </div>
            </form>
            <form id="change_form" class="layui-form" action="" lay-filter="change_form" hidden>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">积分</label>
                        <div class="layui-input-inline">
                            <input type="text" name="score" autocomplete="off" class="layui-input" >
                        </div>
                        <button id="addScore" class="layui-btn">修改</button>
                    </div>
                </div>
            </form>
            <div class="layui-form">
                <table class="layui-table" id="userTable" lay-data="{id: 'userTable'}">
                    <thead><tr>
                        <th lay-data="{field:'card', width:150}">卡号</th>
                        <th lay-data="{field:'name', width:150}">姓名</th>
                        <th lay-data="{field:'score', width:150}">积分</th>
                        <th lay-data="{field:'last_change', width:150}">最近修改</th>
                        <th lay-data="{field:'phone', width:150}">电话</th>
                        <th lay-data="{field:'dress', width:200}">住址</th>
                        <th lay-data="{field:'remarks'}">备注</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="layui-tab-item">用户的增删改查</div>
        <div class="layui-tab-item">积分的增删改查</div>
    </div>
</div>

<script src="layui/layui.js" charset="utf-8"></script>
<script>
    const { invoke } = window.__TAURI__.tauri;
    layui.use(['form'], function(){
        const $ = layui.jquery;
        const form = layui.form;
        const table = layui.table;
        const layer = layui.layer;
        const changeForm = $("form[lay-filter='change_form']");
        const scoreInput = $("input[name='score']");
        const cardInput = $("input[name='card']");
        cardInput.trigger("focus");
        table.init("userTable", {});
        async function getUser(card) {
            if (card === "") {
                layer.msg("卡号不能为空",{time: 600});
                return false;
            }
            let data = await invoke("user_info", { card: card });
            let user = JSON.parse("{"+data+"}");
            if (user.card === undefined) {
                layer.msg("没有找到会员",{time: 600});
                return false;
            }
            table.reload('userTable', {data: [user]});
            changeForm.attr("hidden", false);
            scoreInput.val("");
            scoreInput.trigger("focus");
        }
        $(document).on("click", "#search", function () {
            getUser(form.val("user_form").card);
            return false;
        });
        async function addScore(card, addScore) {
            let data = await invoke("user_add_score", { card: card, addScore: Number(addScore) });
            let user = JSON.parse("{"+data+"}");
            table.reload('userTable', {data: [user]});
            changeForm.attr("hidden", true);
            cardInput.val("");
            cardInput.trigger("focus");
        }
        $(document).on("click", "#addScore", function () {
            let card = form.val("user_form").card;
            if (card !== table.getData("userTable")[0].card) {
                layer.msg("输入框中卡号与查询结果中卡号不一致",{time: 600});
                return false;
            }
            let score = form.val("change_form").score;
            if (Number(score) === 0) {
                layer.msg("积分不能为0",{time: 600});
                return false;
            }
            let msg = "给 '"+ table.getData("userTable")[0].name +"' 加 '"+ score +"' 分吗？";
            let keyDown = document.onkeydown;
            let addScoreAndCloseConfirm = function (confirmIndex) {
                document.onkeydown = keyDown;
                addScore(card, score);
                layer.close(confirmIndex);
            };
            let confirmIndex = layer.confirm(msg, {closeBtn: 0, title:"提示", }
            , addScoreAndCloseConfirm, function () {
                document.onkeydown = keyDown;
            });
            document.onkeydown = function (e) {
                if (e.code === "NumpadEnter" || e.code === "Enter") {
                    addScoreAndCloseConfirm(confirmIndex);
                } else if (e.code === "Escape") {
                    layer.close(confirmIndex);
                    document.onkeydown = keyDown;
                }
                console.log(e.code);
                return false;
            };
            return false;
        });

    });
</script>

</body>
</html>